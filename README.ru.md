# Модуль наблюдения

Модуль наблюдения - это устройство, которое регулирует колиечство подаваемого реагента в раствор, с помощью насоса; контроллирует количество реагента в баке; регистрирует давление, уровень жидкости в баке; отправляет зарегистрированные данные на сервер.
Устройство может быть настроено, с помощью команд сервера, а также с помощью специальных команд, переданных по UART.

## README перевод
- [English](README.md)
- [Русский](README.ru.md)

### Индикация состояний

Устройство иммет внешнюю одноцветную лавмпу и внутренний двухцветный светодиод, которые сигнализируют о внутреннем состоянии устройства.

| Состояние | Внутренний светодиод | Внешняя лампа |
| --- | --- | --|
| Насос выключен | Красный цвет: 6 сек - выкл, 300 мсек - вкл; зелёный цвет: выкл | лампа: 6 сек - выкл, 300 мсек - вкл |
| Насос включен | Красный цвет: вкл; зелёный цвет: выкл | лампа: вкл |
| Насос в работе | Красный цвет: 1 сек - выкл, 1 сек - вкл; зелёный цвет: 1 сек - вкл, 1 сек - выкл | лампа: 1 сек - выкл, 1 сек - вкл |
| Внутренняя ошибка | Жёлтый свет | - |

### Расчёт вроемени работы насоса:

Время работы рассчитывается каждые 15 мин и устройство, на это время, включает насос (время не может быть больше 15 минут).
Устройство рассчитывает время работы, испольлзуя следующие вормулы:

![img](https://github.com/DrDeLaBill/monitoring_module/assets/40359652/799f6bd4-4b38-43ea-82ec-da083f9f2810)
- V<sub>dused</sub>  - количество жмдкости, использованной за день [мл]
- t<sub>wday</sub> - врем работы насоса на текущие сутки [сек]
- U<sub>p</sub> - скорость работы насоса [мл/час]

![img](https://github.com/DrDeLaBill/monitoring_module/assets/40359652/affad669-8753-4d57-8f92-6ef8b3f1e6ae)
- N<sub>p</sub> - количество периодов работы, оставшихся до конца дня
- Δt - количество секунд, оставшихся до конца дня [сек]
- t<sub>pp</sub> - период работы насоса (по-умолчанию: 900) [сек]

![img](https://github.com/DrDeLaBill/monitoring_module/assets/40359652/ad8cc8b8-e089-4def-940a-c5bdc2c2a946)
- V<sub>p</sub> - необходимый объём жидкости для текущего периода [мл]
- V<sub>dneed</sub> - необходимый объём жидкости в день [мл]

![img](https://github.com/DrDeLaBill/monitoring_module/assets/40359652/1188ced4-4314-4b3c-af24-26b66a4621fa)
- t<sub>w</sub> - рассчитанное время работы насоса для текущего периода [сек]


Если t<sub>w</sub> > t<sub>pp</sub>, тогда t<sub>w</sub> = t<sub>pp</sub>
  
Если t<sub>w</sub> < t<sub>pmin</sub>, тогда t<sub>w</sub> = 0
  
t<sub>pmin</sub> - минимальная длительность работы насоса (по-умолчанию: 30) [сек]


### UART команды:

- Стандартные:
    - ```status``` - показать текущие настройки устройства
    - ```saveadcmin``` - сохранить текущее значение АЦП, измеряющего уровень жидкости в баке, как минимальное значение (это значение тем больше стремится к максимуму, чем меньше жидкости в баке)
    - ```saveadcmax``` - сохранить текущее значение АЦП, измеряющего уровень жидкости в баке, как максимальное значение (это значение тем больше стремится к минимому, чем больше жидкости в баке)
    - ```default``` - сбросить настройки
    - ```clearlog``` - сбросить состояние устройства
    - ```clearpump``` - сбросить состояние насоса
    - ```pump``` - показать текущее состояние насоса
    - ```reset``` - удалить все сохранённые записи в журнале (в процессе разработки)
    - ```setid <uint32_t id>``` - сохранить новый идентификатор модуля
    - ```setsleep <uint32_t time>``` - сохранить новое время периода записи данных в журнале (в секундах)
    - ```seturl <string url>``` - сохранить новый URL сервера
    - ```setport <string port>``` - сохранить новый порт сервера
    - ```setlitersmin <uint32_t liters>``` - установить минимальное количество жидкости (в миллилитрах)
    - ```setlitersmax <uint32_t liters>``` - установить максимальное количество жидкости (в миллилитрах)
    - ```settarget <uint32_t liters>``` - установить целевое количество жидкости, прокачиваемое насосом за день (в миллилитрах)
    - ```setpumpspeed <uint32_t liters>``` - установить скорость прокачки насоса (в миллилитрах в час)
    - ```setlogid <uint32_t id>``` - установить идентификатор записи журнала, требующей передачи на сервер
    - ```delrecord <uint32_t id>``` - удалить запись жжурнала из памяти устройства, по его идентификатору
    - ```setpower <bool enabled>``` - разрешить/запретить работу насоса
- Команды отладки:
    - ```reseteepromerr``` - сбросить данные EEPROM об ошибках памяти
    - ```setadcmin <uint32_t adc_val>``` - установить определённое значение АЦП, как минимальное (это значение тем больше стремится к максимуму, чем меньше жидкости в баке)
    - ```setadcmin <uint32_t adc_val>``` - установить определённое значение АЦП, как максимальное (это значение тем больше стремится к минимому, чем больше жидкости в ба
    - ```setcвклfigver <uint32_t cf_id>``` - установить определённое значение версии конфигурации настроек (не изменяет сами настройки)


### Пример POST-запроса:

Устройство отправляет на сервер POST-запрос подобного вида:
```
POST /api/log/ep HTTP/1.1
Host: (IP/URL)
User-Agent: module
Cвклnectiвкл: close
Accept-Charset: utf-8, us-ascii
Cвклtent-Type: text/plain
Cвклtent-Length: 100

id=123
fw_id=2
cf_id=1
t=2000-01-01T00:00:01
d=id=5;level=0.0;press_1=0.61;pumpw=100;pumpd=100;t=2000-01-01T00:00:01
```
или без данных о записи в журнале:
```
POST /api/log/ep HTTP/1.1
Host: (IP/URL)
User-Agent: module
Cвклnectiвкл: close
Accept-Charset: utf-8, us-ascii
Cвклtent-Type: text/plain
Cвклtent-Length: 100

id=123
fw_id=2
cf_id=1
t=2000-01-01T00:00:01
```
- ```id``` - текущий идентификатор устройства
- ```fw_id``` - текущая версия прошивки
- ```cf_id``` - текущая версия конфигурации
- ```t``` - текущее время устройства
- ```d``` - данные
    - ```id``` - уникальный идентификатор записи журнала
    - ```level``` - уроввень жидкости (литры)
    - ```press_1``` - давление, считываемое первым датчиком (МПа)
    - ```pumpw``` - время работы насоса на момент создания записи журнала (сек)
    - ```pumpd``` - время простоя насоса на момент создания записи журнала (сек)
    - ```t``` - время записи журнала


### POST-ответ, ожидаемый от сервера:

Если устройство имеет отличный от сервера ```cf_id```:
```
HTTP/1.1 200 OK
server: nginx/1.18.0
date: t
referrer-policy: same-origin
cross-origin-opener-policy: same-origin

t=2023-01-19t12:56:09.386436
d_hwm=0
cf_id=33077616
cf=id=123;ltrmin=10;ltrmax=375;trgt=10000;sleep=900;speed=1600;clr=0;pwr=1;logid=1
```

Если устройство и сервер имеют идентичный ```cf_id```:
```
HTTP/1.1 200 OK
server: nginx/1.18.0
date: t
referrer-policy: same-origin
cross-origin-opener-policy: same-origin

t=2023-01-19t12:56:09.386436
d_hwm=0
```

- ```t``` - текущее время
- ```d_hwm``` - последний идентификатор записи журнала, хранящегося на сервере
- ```cf_id``` - текущая версия конфигурации (обновляется, если настройки на сервере меняются)
- ```cf``` - данные настроек
    - ```id``` - новый идентификатор устройства
    - ```ltrmin``` - минимальный объём жидкости в баке (литры)
    - ```ltrmax``` - максимальный объём жидкости в баке (литры)
    - ```trgt``` -  целевое количество жидкости, прокачиваемое насосом за день (миллилитры)
    - ```sleep``` - время периода записи данных в журнал (секунды)
    - ```speed``` - скорость прокачки насоса (миллилитры в час)
    - ```clr``` - удалить все сохранённые записи в журнале (в процессе разработки)
    - ```pwr``` - разрешить/запретить работу насоса
